(module test_new_stdlib_functions
  (import json_utils)
  (import result)
  (import http)
  (import string_utils)
  
  (fn test_json_new_object -> int
    (set obj map (call json_new_object))
    (ret 1))
  
  (test-spec test_json_new_object
    (case "creates new json object"
      (input)
      (expect 1)))
  
  (fn test_json_new_array -> int
    (set arr array (call json_new_array))
    (ret 1))
  
  (test-spec test_json_new_array
    (case "creates new json array"
      (input)
      (expect 1)))
  
  (fn test_json_set_get name string -> int
    (set obj map (call json_new_object))
    (set obj map (call json_set obj "name" name))
    (set result string (call json_get obj "name"))
    (set matches bool (call string_eq result name))
    (if matches
      (ret 1))
    (ret 0))
  
  (test-spec test_json_set_get
    (case "sets and gets value"
      (input "test")
      (expect 1)))
  
  (fn test_json_push_length val string -> int
    (set arr array (call json_new_array))
    (set arr array (call json_push arr val))
    (ret (call json_length arr)))
  
  (test-spec test_json_push_length
    (case "pushes value and gets length"
      (input "hello")
      (expect 1)))
  
  (fn test_error_code code int -> int
    (set err_result map (call err code "Test error"))
    (ret (call error_code err_result)))
  
  (test-spec test_error_code
    (case "extracts error code 404"
      (input 404)
      (expect 404))
    (case "extracts error code 500"
      (input 500)
      (expect 500)))
  
  (fn test_get_status_text code int -> string
    (ret (call get_status_text code)))
  
  (test-spec test_get_status_text
    (case "returns OK for 200"
      (input 200)
      (expect "OK"))
    (case "returns Not Found for 404"
      (input 404)
      (expect "Not Found")))
  
  (fn test_string_reverse text string -> string
    (ret (call string_reverse text)))
  
  (test-spec test_string_reverse
    (case "reverses hello"
      (input "hello")
      (expect "olleh"))
    (case "reverses empty string"
      (input "")
      (expect "")))
  
  (meta-note "Tests new stdlib functions: json helpers, error_code, get_status_text, string_reverse"))
