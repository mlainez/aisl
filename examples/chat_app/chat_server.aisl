(module chat_server
  (fn main -> int
    (set port int 8080)
    (set server socket (tcp_listen port))
    (print "Echo server on port 8080")

    (loop
      (set client socket (tcp_accept server))
      (loop
        (set data string (tcp_receive client 1024))
        (if (eq (string_length data) 0)
          (break))
        (tcp_send client data)))

    (ret 0)))
